@page "/monitor/{instanceId}"
@using System
@model WebsiteMonitor.App.Pages.Monitor.IndexModel

@{
    var title = string.IsNullOrWhiteSpace(Model.DisplayName)
        ? $"WebsiteMonitor - {Model.InstanceId}"
        : $"WebsiteMonitor - {Model.DisplayName}";
}

<h1 class="wm-title">@title</h1>

<div class="wm-meta">
  <span>Last Check (UTC): </span><span id="wm-lastcheck">@Model.LastCheckUtc</span>
  <span class="wm-meta-sep">|</span>
  <span>InstanceId: @Model.InstanceId</span>
</div>

<div class="wm-nav">
  <a href="/setup/instances/@Model.InstanceId">Configure</a>
  <span class="wm-nav-sep">|</span>
  <a href="/setup">Setup</a>
  <span class="wm-nav-sep">|</span>
  <a href="/">Home</a>
</div>

<style>
  body { font-family: Calibri, "Segoe UI", Arial, sans-serif; }

  .wm-title { margin: 6px 0 4px 0; font-size: 18px; font-weight: 600; }
  .wm-meta { margin: 0 0 6px 0; font-size: 12px; opacity: 0.9; }
  .wm-meta-sep { margin: 0 6px; opacity: 0.6; }

  .wm-nav { margin: 0 0 10px 0; font-size: 12px; }
  .wm-nav a { text-decoration: none; }
  .wm-nav a:hover { text-decoration: underline; }
  .wm-nav-sep { margin: 0 6px; opacity: 0.6; }

  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 6px; vertical-align: top; }
  th { text-align: left; font-size: 12px; opacity: 0.9; }
  td { font-size: 13px; }

  tr.wm-up { background-color: rgba(0, 180, 0, 0.15); }
  tr.wm-down { background-color: rgba(220, 0, 0, 0.14); }
  tr.wm-unknown { background-color: rgba(128, 128, 128, 0.14); }
  tr.wm-degraded { background-color: rgba(255, 215, 0, 0.14); }

  .wm-site1 { font-size: 14px; line-height: 1.15; }
  .wm-site2 { opacity: 0.75; font-size: 12px; margin-top: 2px; line-height: 1.15; }

  a.wm-link { color: inherit; text-decoration: none; }
  a.wm-link:hover { text-decoration: underline; cursor: pointer; }

  .wm-since1 { font-size: 13px; line-height: 1.15; }
  .wm-since2 { opacity: 0.85; font-size: 12px; margin-top: 2px; line-height: 1.15; }

  table, th, td { border: 1px solid rgba(255,255,255,0.15); }
</style>

<table>
  <thead>
    <tr>
      <th style="width: 46%;">Site</th>
      <th style="width: 9%;">TCP</th>
      <th style="width: 7%;">HTTP</th>
      <th style="width: 12%;">Check</th>
      <th style="width: 10%;">State</th>
      <th style="width: 16%;">Since (UTC)</th>
    </tr>
  </thead>
  <tbody id="wm-body">
@foreach (var r in Model.Rows)
{
    var cls = r.State.Equals("Up", StringComparison.OrdinalIgnoreCase) ? "wm-up"
            : r.State.Equals("Down", StringComparison.OrdinalIgnoreCase) ? "wm-down"
            : r.State.Equals("Degraded", StringComparison.OrdinalIgnoreCase) ? "wm-degraded"
            : "wm-unknown";

    <tr class="@cls"
        data-targetid="@r.TargetId"
        data-state="@r.State"
        data-baseduration="@r.DurationSeconds">
      <td>
        <div class="wm-site1">
          <a class="wm-link" href="@r.Url" target="_blank" rel="noopener noreferrer">@r.Url</a>
        </div>
        <div class="wm-site2">@r.FinalUrl</div>
      </td>
      <td>@r.Tcp</td>
      <td>@r.Http</td>
      <td>@r.Check</td>
      <td>@r.State</td>
      <td>
        <div class="wm-since1">@r.SinceUtc</div>
        <div class="wm-since2"><span class="wm-age"></span></div>
      </td>
    </tr>
}
  </tbody>
</table>

<script>
(() => {
  const instanceId = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.InstanceId));
  const pollMs = 10000;

  let lastPollAtMs = Date.now();

  function rowClass(state) {
    const s = (state || "").toLowerCase();
    if (s === "up") return "wm-up";
    if (s === "down") return "wm-down";
    if (s === "degraded") return "wm-degraded";
    return "wm-unknown";
  }

  function formatDuration(totalSec) {
    totalSec = Math.max(0, Math.floor(totalSec || 0));
    const days = Math.floor(totalSec / 86400);
    totalSec -= days * 86400;
    const hours = Math.floor(totalSec / 3600);
    totalSec -= hours * 3600;
    const mins = Math.floor(totalSec / 60);
    const secs = totalSec - mins * 60;

    const hh = String(hours).padStart(2, "0");
    const mm = String(mins).padStart(2, "0");
    const ss = String(secs).padStart(2, "0");

    return days > 0 ? `${days}:${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
  }

  function updateAges() {
    const now = Date.now();
    const deltaSec = (now - lastPollAtMs) / 1000;

    document.querySelectorAll("#wm-body tr").forEach(tr => {
      const base = parseInt(tr.dataset.baseduration || "0", 10) || 0;
      const state = (tr.dataset.state || "").toLowerCase();
      const ageEl = tr.querySelector(".wm-age");
      if (!ageEl) return;

      const label =
        state === "down" ? "Down" :
        state === "degraded" ? "Degraded" :
        state === "unknown" ? "Unknown" :
        "Up";

      ageEl.textContent = `${label}: ${formatDuration(base + deltaSec)}`;
    });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function renderRows(rows) {
    const body = document.getElementById("wm-body");
    if (!body) return;

    body.innerHTML = "";

    for (const r of (rows || [])) {
      const tr = document.createElement("tr");
      tr.className = rowClass(r.state);
      tr.dataset.targetid = String(r.targetId);
      tr.dataset.state = r.state || "Unknown";
      tr.dataset.baseduration = r.durationSeconds || "0";

      const tdSite = document.createElement("td");
      tdSite.innerHTML =
        `<div class="wm-site1">` +
          `<a class="wm-link" href="${escapeHtml(r.url || "")}" target="_blank" rel="noopener noreferrer">` +
            `${escapeHtml(r.url || "")}` +
          `</a>` +
        `</div>` +
        `<div class="wm-site2">${escapeHtml(r.finalUrl || "")}</div>`;

      const tdTcp = document.createElement("td");
      tdTcp.textContent = r.tcp || "";

      const tdHttp = document.createElement("td");
      tdHttp.textContent = r.http || "";

      const tdCheck = document.createElement("td");
      tdCheck.textContent = r.check || "";

      const tdState = document.createElement("td");
      tdState.textContent = r.state || "";

      const tdSince = document.createElement("td");
      tdSince.innerHTML =
        `<div class="wm-since1">${escapeHtml(r.sinceUtc || "")}</div>` +
        `<div class="wm-since2"><span class="wm-age"></span></div>`;

      tr.appendChild(tdSite);
      tr.appendChild(tdTcp);
      tr.appendChild(tdHttp);
      tr.appendChild(tdCheck);
      tr.appendChild(tdState);
      tr.appendChild(tdSince);

      body.appendChild(tr);
    }

    lastPollAtMs = Date.now();
    updateAges();
  }

  async function poll() {
    try {
      const url = `/monitor/${encodeURIComponent(instanceId)}?handler=Data`;
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) return;

      const data = await resp.json();

      const lastCheck = document.getElementById("wm-lastcheck");
      if (lastCheck) lastCheck.textContent = data.lastCheckUtc || "";

      renderRows(data.rows || []);
    } catch {
      // ignore transient poll failures
    }
  }

  setInterval(updateAges, 1000);
  setInterval(poll, pollMs);
  updateAges();
})();
</script>
