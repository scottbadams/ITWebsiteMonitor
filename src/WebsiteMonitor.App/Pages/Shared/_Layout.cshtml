@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using WebsiteMonitor.Storage.Data
@{
    var appName = "ITWebsiteMonitor";
    var pageTitle = (ViewData["Title"] as string) ?? "";
    var fullTitle = string.IsNullOrWhiteSpace(pageTitle) ? appName : $"{appName} - {pageTitle}";
    var hc = ViewContext?.HttpContext;

    // embed mode (used by Home-page iframes/tabs) hides the header chrome
    var embedParam = (hc?.Request?.Query["embed"].ToString() ?? "");
    var isEmbed =
        string.Equals(embedParam, "1", StringComparison.OrdinalIgnoreCase) ||
        string.Equals(embedParam, "true", StringComparison.OrdinalIgnoreCase);

    // Prevent "section defined but not rendered" errors when a page is embedded.
    if (isEmbed)
    {
        // These are optional sections, but defining them on a page still requires the layout
        // to either render or explicitly ignore them.
        IgnoreSection("HeaderRight");
        IgnoreSection("PageActions");
        IgnoreSection("PageActionsPre");
    }

    // Default logo (static). If SystemSettings defines LogoPath, use it.
    // NOTE: Use an absolute app-root path so it works even if MVC tag helpers are disabled.
    var logoSrc = "/images/itgreatfalls-logo.png";
    try
    {
        var db = hc?.RequestServices.GetService<WebsiteMonitorDbContext>();
        if (db != null)
        {
            var ss = db.SystemSettings.AsNoTracking().FirstOrDefault(s => s.Id == 1);
            if (ss != null && !string.IsNullOrWhiteSpace(ss.LogoPath))
            {
                logoSrc = ss.LogoPath.StartsWith("/") ? ss.LogoPath : ("/" + ss.LogoPath);
            }
        }
    }
    catch { }

    // If we're being rendered inside a cross-site iframe (e.g. Zabbix), browsers may apply "auto dark"
    // and sandboxing may block popups/new tabs. Detect this without requiring query-string flags.
    var fetchDest = hc?.Request?.Headers["Sec-Fetch-Dest"].ToString() ?? "";
    var fetchSite = hc?.Request?.Headers["Sec-Fetch-Site"].ToString() ?? "";
    var isCrossSiteIframe =
        string.Equals(fetchDest, "iframe", StringComparison.OrdinalIgnoreCase) &&
        string.Equals(fetchSite, "cross-site", StringComparison.OrdinalIgnoreCase);

    // Home propagates z=1 to nested iframes when ITWebsiteMonitor is framed in Zabbix.
    // Use it to apply iframe-safe navigation behavior only in Zabbix (not during normal browsing).
    var zParam = ((hc?.Request?.Query["z"].ToString() ?? "").Trim());
    var isZabbixChild =
        string.Equals(zParam, "1", StringComparison.OrdinalIgnoreCase) ||
        string.Equals(zParam, "true", StringComparison.OrdinalIgnoreCase);

    var isZabbixFrame = isCrossSiteIframe;


    // Theme preference (claims transformation adds wm:theme=dark/light).
    // If the user forces dark theme, it overrides all other scheme detection/overrides.
    var themePref = "light";
    try
    {
        var t = User?.FindFirst("wm:theme")?.Value;
        if (!string.IsNullOrWhiteSpace(t)) themePref = t;
    }
    catch { }

    var isUserForcedDark = string.Equals(themePref, "dark", StringComparison.OrdinalIgnoreCase);

    // Optional query override: ?scheme=light|dark
    // If not set and we're cross-site framed, default to light (prevents "double dark" effects)
    // unless the user has forced dark theme.
    var schemeParamRaw = ((hc?.Request?.Query["scheme"].ToString() ?? "").Trim());
    string? forcedScheme = null;
    if (!isUserForcedDark &&
        (string.Equals(schemeParamRaw, "light", StringComparison.OrdinalIgnoreCase) ||
         string.Equals(schemeParamRaw, "dark", StringComparison.OrdinalIgnoreCase)))
    {
        forcedScheme = schemeParamRaw.ToLowerInvariant();
    }
    if (!isUserForcedDark && forcedScheme == null && isCrossSiteIframe)
    {
        forcedScheme = "light";
    }

    var effectiveTheme = isUserForcedDark ? "dark" : (forcedScheme ?? themePref);
    var themeClass = string.Equals(effectiveTheme, "dark", StringComparison.OrdinalIgnoreCase) ? "theme-dark" : "theme-light";
    var forceClass = forcedScheme == "dark" ? "wm-force-dark" : (forcedScheme == "light" ? "wm-force-light" : "");
    var bodyClass = string.IsNullOrWhiteSpace(forceClass) ? themeClass : (themeClass + " " + forceClass);

    // Communicate intent to the browser (helps reduce auto-dark restyling when embedded).
    var colorSchemeMeta = string.Equals(effectiveTheme, "dark", StringComparison.OrdinalIgnoreCase)
        ? "dark"
        : "light";

    // Only when framed in Zabbix: keep navigation inside the same frame (avoid new tabs/popups).
    var forceSameWindow = isZabbixFrame || isZabbixChild;

    // Close button: show unless explicitly hidden, and never in embed mode
    var showClose = !(ViewData["HideClose"] as bool? ?? false);

    // On the Home page when framed in Zabbix, hide "Close" (it cannot reliably close the parent tab/window).
    var pathVal = hc?.Request?.Path.Value ?? "";
    var isHomePath = string.Equals(pathVal, "/", StringComparison.OrdinalIgnoreCase) || string.IsNullOrEmpty(pathVal);
    if (showClose && isHomePath && (isZabbixFrame || isZabbixChild))
    {
        showClose = false;
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="@colorSchemeMeta" />
    @if (forceSameWindow)
    {
        <base target="_self" />
    }

    <title>@fullTitle</title>

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    @RenderSection("Styles", required: false)
</head>
<body class="@bodyClass">

@* When in embed mode we hide the header chrome. If a page defines header sections, we must
   explicitly ignore them, otherwise Razor will throw at runtime. *@
@if (isEmbed)
{
    if (IsSectionDefined("HeaderRight")) { IgnoreSection("HeaderRight"); }
    if (IsSectionDefined("PageActions")) { IgnoreSection("PageActions"); }
    if (IsSectionDefined("PageActionsPre")) { IgnoreSection("PageActionsPre"); }
    if (IsSectionDefined("HeaderUnderLogo")) { IgnoreSection("HeaderUnderLogo"); }
}
else
{
    <div class="wm-topbar" style="padding:10px;">
        <div class="wm-topbar-title">
            <img class="wm-logo" src="@logoSrc" alt="Logo" />
            <span id="wm-topbar-title-text">@fullTitle</span>
        </div>

        <div class="wm-topbar-actions">
            @RenderSection("PageActionsPre", required: false)
            @{
                var isHomePage =
                    string.Equals(hc?.Request?.Path.Value, "/", StringComparison.OrdinalIgnoreCase) ||
                    string.Equals(pageTitle, "Home", StringComparison.OrdinalIgnoreCase);
            }
            @if (isHomePage)
{
    @if (forceSameWindow)
    {
        <a id="wm-topbar-primary-btn" class="wm-btn" asp-page="/Setup/Index">Setup</a>
    }
    else
    {
        <a id="wm-topbar-primary-btn" class="wm-btn" asp-page="/Setup/Index" target="_blank" rel="noopener noreferrer">Setup</a>
    }
}
else
{
    <a id="wm-topbar-primary-btn" class="wm-btn" href="/">Home</a>
}
            @RenderSection("PageActions", required: false)
            <a class="wm-btn" href="/Account/Logout">Log Out</a>

            @if (showClose)
            {
                <button id="wm-close-btn" class="wm-btn" type="button" onclick="window.close()">Close</button>
            }

            @RenderSection("HeaderRight", required: false)
        </div>

        <div class="wm-topbar-under">
            @RenderSection("HeaderUnderLogo", required: false)
        </div>
    </div>
}

<main class="container">
    @RenderBody()
</main>

<script>
  (function () {
    function hasZFlag() {
      try {
        var qs = new URLSearchParams(window.location.search || "");
        var z = (qs.get("z") || "").toLowerCase();
        return z === "1" || z === "true";
      } catch (e) { return false; }
    }

    // Detect cross-origin embedding (e.g., Zabbix) without relying on Sec-Fetch headers,
    // which can change after in-frame navigations.
    function isCrossOriginTopFrame() {
      try {
        if (window.top && window.top !== window.self) {
          // Accessing top.location throws if cross-origin
          var _ = window.top.location.href;
          return false;
        }
        return false;
      } catch (e) {
        return true;
      }
    }

    var zabbixMode = hasZFlag() || isCrossOriginTopFrame();
    if (!zabbixMode) return;


    function needsEmbedForPath(pathname) {
      try {
        var p = (pathname || "").toLowerCase();
        return p.indexOf("/setup/instances/") === 0 || p.indexOf("/setup/targets/") === 0;
      } catch (e) { return false; }
    }

    function ensureEmbedOnConfigure() {
      try {
        if (!needsEmbedForPath(window.location.pathname)) return;

        var qs = new URLSearchParams(window.location.search || "");
        var embed = (qs.get("embed") || "").toLowerCase();

        // If embed is missing, reload once with embed=1 to force the slim iframe UI (Back button, no chrome).
        if (embed !== "1" && embed !== "true") {
          qs.set("embed", "1");
          qs.set("z", "1");
          var newUrl = window.location.pathname + "?" + qs.toString() + (window.location.hash || "");
          window.location.replace(newUrl);
          return;
        }

        // Ensure z=1 is present (used for same-window navigation behavior).
        if (!qs.get("z")) {
          qs.set("z", "1");
          var fixedUrl = window.location.pathname + "?" + qs.toString() + (window.location.hash || "");
          window.history.replaceState(null, "", fixedUrl);
        }
      } catch (e) { }
    }

    function ensureHomeIframesEmbedded() {
      try {
        var p = (window.location.pathname || "").toLowerCase();
        if (p !== "/" && p !== "") return;

        var iframes = document.querySelectorAll("iframe[src]");
        for (var i = 0; i < iframes.length; i++) {
          var src = iframes[i].getAttribute("src");
          if (!src) continue;

          var u = new URL(src, window.location.origin);
          if (u.origin !== window.location.origin) continue;

          // Only touch Monitor tab iframes.
          if (u.pathname.toLowerCase().indexOf("/monitor/") !== 0) continue;

          if (!u.searchParams.has("embed")) u.searchParams.set("embed", "1");
          if (!u.searchParams.has("z")) u.searchParams.set("z", "1");

          var newSrc = u.pathname + (u.search || "") + (u.hash || "");
          if (newSrc !== src) iframes[i].setAttribute("src", newSrc);
        }
      } catch (e) { }
    }

    // If we landed on a configure page without embed=1 (can happen after in-frame navigation),
    // normalize once so the correct iframe UI is shown.
    ensureEmbedOnConfigure();

    function normalizeSameOriginWithZ(urlStr) {
      try {
        var u = new URL(urlStr, window.location.origin);
        if (u.origin !== window.location.origin) return null;

        if (!u.searchParams.has("z")) u.searchParams.set("z", "1");

        // For per-instance configure/targets pages, force embed=1 in Zabbix iframe mode
        // so we consistently render the slim iframe UI.
        if (needsEmbedForPath(u.pathname) && !u.searchParams.has("embed")) {
          u.searchParams.set("embed", "1");
        }

        return u.pathname + (u.search || "") + (u.hash || "");
      } catch (e) { return null; }
    }

    function enforce() {
      try {
        // In cross-site iframe mode, "Close" cannot reliably close the parent window/tab.
        var closeBtn = document.getElementById("wm-close-btn");
        if (closeBtn && closeBtn.parentNode) closeBtn.parentNode.removeChild(closeBtn);

        // Strip _blank targets (sandboxed iframes often block popups/new tabs, which looks like "nothing happens").
        var linksWithTarget = document.querySelectorAll("a[target]");
        for (var i = 0; i < linksWithTarget.length; i++) {
          var t = (linksWithTarget[i].getAttribute("target") || "").toLowerCase();
          if (t === "_blank" || t === "_new") {
            linksWithTarget[i].removeAttribute("target");
            linksWithTarget[i].removeAttribute("rel");
          }
        }

        // Ensure z=1 persists across same-origin navigation while in Zabbix mode.
        var links = document.querySelectorAll("a[href]");
        for (var k = 0; k < links.length; k++) {
          var href = links[k].getAttribute("href");
          if (!href) continue;
          var h = href.trim();
          if (h === "" || h.charAt(0) === "#") continue;
          var low = h.toLowerCase();
          if (low.indexOf("javascript:") === 0 || low.indexOf("mailto:") === 0 || low.indexOf("tel:") === 0) continue;

          var newHref = normalizeSameOriginWithZ(h);
          if (newHref && newHref !== href) links[k].setAttribute("href", newHref);
        }

        // Strip targets from forms and persist z=1 in actions.
        var formsWithTarget = document.querySelectorAll("form[target]");
        for (var j = 0; j < formsWithTarget.length; j++) {
          formsWithTarget[j].removeAttribute("target");
        }

        var forms = document.querySelectorAll("form");
        for (var f = 0; f < forms.length; f++) {
          var action = forms[f].getAttribute("action");
          if (!action) continue;
          var a = action.trim();
          if (a === "") continue;
          var newAction = normalizeSameOriginWithZ(a);
          if (newAction && newAction !== action) forms[f].setAttribute("action", newAction);
        }

        // On Home, ensure tab iframes stay in embed mode after any in-frame navigation.
        ensureHomeIframesEmbedded();
      } catch (e) { }
    }
    enforce();

    try {
      var mo = new MutationObserver(function () { enforce(); });
      mo.observe(document.documentElement, { childList: true, subtree: true });
    } catch (e) { }

    // If any code tries window.open() inside an iframe/sandbox, navigate in the same frame instead.
    try {
      window.open = function (url) {
        if (url) {
          var newUrl = normalizeSameOriginWithZ(url);
          window.location.href = newUrl || url;
        }
        return null;
      };
    } catch (e) { }
  })();
</script>

@RenderSection("Scripts", required: false)

</body>
</html>
